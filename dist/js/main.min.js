var Debug=function(){var settings={isLocal:!1,isActive:!0,keyboardKeys:{toggle:68}},init=function(){settings.isLocal=location.href.indexOf("local")>-1,settings.isActive=settings.isLocal,bindEventHandlers()},bindEventHandlers=function(){window.addEventListener("keyup",function(event){event.keyCode!==settings.keyboardKeys.toggle&&event.which!==settings.keyboardKeys.toggle||(settings.isActive=!settings.isActive,console.log("Toggle debug mode",settings.isActive))})},log=function(){(settings.isLocal||settings.isActive)&&console.log.apply(console,arguments)};return{init:function(){init()},log:log}}();Debug.init();var Viewport=function(){var settings={width:0,height:0,documentHeight:0,nowLoop:Date.now(),fps:1e3/60,scrollTop:-1,_scrollTop:-1,scrollDetectionMode:"scrollEvent",nowScroll:Date.now(),scrollFactor:-1,isScrolledToTop:!1,isScrolledToBottom:!1,scrollTopOffset:20,scrollBottomOffset:20,isScrolledToFirstScreen:!1,isScrolledToLastScreen:!1,scrollToOffset:0,scrollToSpeed:2},init=function(){Debug.log("viewport.init()"),settings.element=$(window),onResizeFinish(),bindEventHandlers(),onScroll(),onLoop()},bindEventHandlers=function(){settings.element.on("resize",function(){settings.resizeDelay?(clearTimeout(settings.resizeDelay),settings.resizeDelay=null):($("html").addClass("resizing"),$(document).trigger("viewport/resize/start")),settings.resizeDelay=setTimeout(function(){$("html").removeClass("resizing"),$(document).trigger("viewport/resize/finish"),settings.resizeDelay=null},500)}),"scrollEvent"==settings.scrollDetectionMode&&settings.element.on("scroll",function(){var now=Date.now(),elapsed=now-settings.nowScroll;elapsed>settings.fps&&(settings.nowScroll=now-elapsed%settings.fps,settings.scrollTop=settings.element.scrollTop(),$(document).trigger("viewport/scroll"))}),$(document).on("viewport/scroll",function(){onScroll()}).on("viewport/resize/finish",function(){onResizeFinish()}).on("viewport/scroll/toTop",function(){Debug.log("scrolled to top"),$("html").addClass("scrolled-to-top")}).on("viewport/scroll/fromTop",function(){Debug.log("scrolled from top"),$("html").removeClass("scrolled-to-top")}).on("viewport/scroll/toBottom",function(){Debug.log("scrolled to bottom"),$("html").addClass("scrolled-to-bottom")}).on("viewport/scroll/fromBottom",function(){Debug.log("scrolled from bottom"),$("html").removeClass("scrolled-to-bottom")}).on("viewport/scroll/toFirstScreen",function(){Debug.log("scrolled to first screen"),$("html").addClass("scrolled-to-first-screen")}).on("viewport/scroll/fromFirstScreen",function(){Debug.log("scrolled from first screen"),$("html").removeClass("scrolled-to-first-screen")}).on("viewport/scroll/toLastScreen",function(){Debug.log("scrolled to last screen"),$("html").addClass("scrolled-to-last-screen")}).on("viewport/scroll/fromLastScreen",function(){Debug.log("scrolled from last screen"),$("html").removeClass("scrolled-to-last-screen")})},onLoop=function(){requestAnimationFrame(onLoop);var now=Date.now(),elapsed=now-settings.nowLoop;elapsed>settings.fps&&(settings.nowLoop=now-elapsed%settings.fps,$(document).trigger("viewport/loop"),"requestAnimationFrame"==settings.scrollDetectionMode&&(settings._scrollTop=settings.scrollTop,settings.scrollTop=settings.element.scrollTop(),settings.scrollTop!=settings._scrollTop&&$(document).trigger("viewport/scroll")))},onResizeFinish=function(){Debug.log("viewport.onResizeFinish()"),settings.width=settings.element.width(),settings.height=settings.element.height(),settings.documentHeight=$("html").outerHeight()},onScroll=function(){Debug.log("viewport.onScroll()"),settings.scrollFactor=settings.scrollTop/(settings.height-settings.documentHeight)*-1,settings.scrollTop>settings.scrollTopOffset&&settings.isScrolledToTop&&(settings.isScrolledToTop=!1,$(document).trigger("viewport/scroll/fromTop")),settings.scrollTop<settings.scrollTopOffset&&(settings.isScrolledToTop||(settings.isScrolledToTop=!0,$(document).trigger("viewport/scroll/toTop"))),settings.scrollTop>settings.documentHeight-settings.height-settings.scrollBottomOffset&&(settings.isScrolledToBottom||(settings.isScrolledToBottom=!0,$(document).trigger("viewport/scroll/toBottom"))),settings.scrollTop<settings.documentHeight-settings.height-settings.scrollBottomOffset&&settings.isScrolledToBottom&&(settings.isScrolledToBottom=!1,$(document).trigger("viewport/scroll/fromBottom")),settings.scrollTop<settings.height&&(settings.isScrolledToFirstScreen||(settings.isScrolledToFirstScreen=!0,$(document).trigger("viewport/scroll/toFirstScreen"))),settings.scrollTop>settings.height&&settings.isScrolledToFirstScreen&&(settings.isScrolledToFirstScreen=!1,$(document).trigger("viewport/scroll/fromFirstScreen")),settings.scrollTop>settings.documentHeight-2*settings.height&&(settings.isScrolledToLastScreen||(settings.isScrolledToLastScreen=!0,$(document).trigger("viewport/scroll/toLastScreen"))),settings.scrollTop<settings.documentHeight-2*settings.height&&settings.isScrolledToLastScreen&&(settings.isScrolledToLastScreen=!1,$(document).trigger("viewport/scroll/fromLastScreen"))},scrollTo=function(target,offset,animate){Debug.log("viewport.scrollTo()"),Debug.log(target);var top=0;"number"==typeof target&&(top=target),"string"==typeof target&&$("#"+target).length>0&&(top=parseInt($("#"+target).offset().top)),"object"==typeof target&&target.length>0&&(top=parseInt(target.offset().top)),top+=offset?offset:settings.scrollToOffset;var distance=Math.floor(Math.abs(top-$(window).scrollTop())),duration=Math.floor(distance/settings.scrollToSpeed);animate?$("html, body").animate({scrollTop:top},duration):settings.element.scrollTop(top)},getWidth=function(){return settings.width},getHeight=function(){return settings.height},getScrollTop=function(){return settings.scrollTop},getScrollFactor=function(){return settings.scrollFactor};return{init:function(){init()},scrollTo:function(target,offset,animate){scrollTo(target,offset,animate)},getWidth:function(){return getWidth()},getHeight:function(){return getHeight()},getScrollTop:function(){return getScrollTop()},getScrollFactor:function(){return getScrollFactor()}}}();$(document).ready(function(){Viewport.init()});var Sequencer=function(){var settings={keyboardKeys:{67:0,86:1,66:2,78:3,77:4},iskeyDown:!1,samples:{808:{0:{src:"dist/samples/808/mp3/bass.mp3",velocity:1},1:{src:"dist/samples/808/mp3/clap.mp3",velocity:1},2:{src:"dist/samples/808/mp3/hi--hat.mp3",velocity:.75},3:{src:"dist/samples/808/mp3/snare.mp3",velocity:1},4:{src:"dist/samples/808/mp3/tom.mp3",velocity:1}}},bpm:108,division:16,isPlaying:!1,isRecording:!0,isLoaded:!1,isMetronoming:!1,sequence:[],lastStep:0,timeLastStep:0,timeBetweenSteps:0,analyserValue:0},init=function(){Debug.log("Sequencer.init()"),initSampler(),initSignal(),initPlayback(),initMetronome(),buildDemoSequence(),startPlayback(),bindEventHandlers()},bindEventHandlers=function(){Debug.log("Sequencer.bindEventHandlers()"),Tone.Buffer.on("load",function(){$(document).trigger("sequencer/loaded")}),$(document).on("sequencer/loaded",function(){Debug.log("All samples are loaded"),settings.isLoaded=!0}).on("keydown",function(event){if(event.preventDefault(),!settings.isKeyDown){settings.isKeyDown=!0;var key=event.which;void 0!==settings.keyboardKeys[key]&&(playSample(settings.keyboardKeys[key]),settings.isRecording&&addSequenceItem(settings.keyboardKeys[key])),32===key&&togglePlayback(),16===key&&toggleMetronome(),88===key&&clearSequence()}}).on("keyup",function(event){event.preventDefault(),settings.isKeyDown=!1}).on("ui/clickButton",function(event,data){if(void 0!==data.sample){var sample=data.sample;playSample(sample),settings.isRecording&&addSequenceItem(sample)}if(data.action){var action=data.action;"play"===action&&togglePlayback(),"clear"===action&&clearSequence(),"metronome"===action&&toggleMetronome()}}).on("url/init",function(event,data){var hash=data.hash;hash?loadSequence(hash):setTimeout(function(){buildDemoSequence()},0)}).on("sequencer/changeSequence",function(){saveSequence()})},initSignal=function(){settings.sampler.toMaster()},initSampler=function(){Debug.log("Sequencer.initSampler()");for(var samples={808:{}},i=0;i<Object.keys(settings.samples[808]).length;i++)samples[808][i]=settings.samples[808][i].src;settings.sampler=new Tone.Sampler(samples)},playSample=function(i,time){if(Debug.log("Sequencer.playSample()",i),settings.isLoaded){var velocity=settings.samples[808][i].velocity;settings.sampler.triggerAttack("808."+i,time,velocity),$(document).trigger("sequencer/playSample",[{sample:i}])}},initPlayback=function(){Debug.log("Sequencer.initPlayback()"),clearSequence(),Tone.Transport.bpm.value=settings.bpm,settings.events=[];for(var i=0;i<settings.division;i++)settings.events.push(i);settings.loop=new Tone.Sequence(function(time,note){settings.timeBetweenSteps=time-settings.timeLastStep,settings.lastStep=note,settings.timeLastStep=time,settings.isMetronoming&&(0===note&&playMetronome(!0),note===settings.division/4*1&&playMetronome(),note===settings.division/4*2&&playMetronome(),note===settings.division/4*3&&playMetronome());for(var i=0;i<Object.keys(settings.samples[808]).length;i++)1===settings.sequence[i][note]&&(playSample(i),$(document).trigger("sequencer/playStep",[{note:note}])),2===settings.sequence[i][note]&&(settings.sequence[i][note]=1);$(document).trigger("sequencer/step",[{note:note}])},settings.events,settings.division+"n"),Tone.Transport.start()},startPlayback=function(){Debug.log("Sequencer.startPlayback()"),settings.isPlaying=!0,$(document).trigger("sequencer/startPlayback"),settings.loop.start()},stopPlayback=function(){Debug.log("Sequencer.stopPlayback()"),settings.isPlaying=!1,$(document).trigger("sequencer/stopPlayback"),settings.loop.stop()},togglePlayback=function(){settings.isPlaying?stopPlayback():startPlayback()},addSequenceItem=function(i,note){if(Debug.log("Sequencer.addSequenceItem()",i,note),settings.isPlaying&&settings.isRecording){if(!note){var note=Math.round(settings.division*settings.loop.progress);note>=settings.division&&(note=0)}Debug.log("note",note);var pending=settings.division*settings.loop.progress<note;settings.sequence[i][note]||(settings.sequence[i][note]=pending?2:1,$(document).trigger("sequencer/changeSequence",[{sequence:settings.sequence}]),$(document).trigger("sequencer/addSequenceItem",[{note:note,sample:i,division:settings.division}]))}},saveSequence=function(){Debug.log("Sequencer.saveSequence()");for(var data="",data=[],i=0;i<settings.division;i++)data.push([]);for(var i=0;i<settings.sequence.length;i++)for(var j=0;j<settings.sequence[i].length;j++)settings.sequence[i][j]&&data[j].push(i);for(var string="",i=0;i<data.length;i++)data[i].length>0&&(string+=String.fromCharCode(i+65),string+=data[i].join(""));Debug.log(string),$(document).trigger("sequencer/saveSequence",[{data:string}])},loadSequence=function(string){Debug.log("Sequencer.loadSequence()",string);var matches=string.match(/[A-Za-z][0-9]+/g);if(matches)for(var i=0;i<matches.length;i++){var match=matches[i],note=match[0].charCodeAt(0)-65,samples=match.substr(1,match.length);if(samples.length>0){samples=samples.split("");for(var j=0;j<samples.length;j++)addSequenceItem(samples[j],note)}}},clearSequence=function(){Debug.log("Sequencer.clearSequence()");for(var i=0;i<Object.keys(settings.samples[808]).length;i++){for(var track=[],j=0;j<settings.division;j++)track[j]=0;settings.sequence[i]=track}$(document).trigger("sequencer/clearSequence"),$(document).trigger("sequencer/changeSequence")},buildDemoSequence=function(){Debug.log("Sequencer.buildDemoSequence()"),settings.sequence[0][0]=1,$(document).trigger("sequencer/addSequenceItem",[{note:0,sample:0,division:settings.division}])},initMetronome=function(){Debug.log("Sequencer.initMetronome()"),settings.metronome=(new Tone.SimpleSynth).toMaster()},toggleMetronome=function(){settings.isMetronoming=!settings.isMetronoming,$(document).trigger("sequencer/toggleMetronome",[{state:settings.isMetronoming}])},playMetronome=function(high){var note=high?"C5":"C4";settings.metronome.triggerAttackRelease(note,"16n",null,.75)},getProgress=function(){return settings.loop?settings.loop.progress:!1},getSequence=function(){return settings.sequence},getDivision=function(){return settings.division};return{init:function(){init()},getProgress:function(){return getProgress()},getSequence:function(){return getSequence()},getDivision:function(){return getDivision()}}}();$(document).ready(function(){Sequencer.init()});var Timeline=function(){var settings={selector:{wrapper:".timeline-wrapper",timeline:"#timeline",placeholder:"#placeholder",note:".timeline-note"},layer:{track:"timeline--track",runner:"timeline--runner"},layerNotes:{0:"timeline--note-0",1:"timeline--note-1",2:"timeline--note-2",3:"timeline--note-3",4:"timeline--note-4"},notes:[],svg:{},svgLoaded:0,isLoaded:!1,zIndex:0,zIndexStep:100},init=function(){Debug.log("Timeline.init()"),bindEventHandlers(),build(),$(document).trigger("timeline/init")},bindEventHandlers=function(){$(document).on("viewport/loop",function(){onLoop()}).on("viewport/resize/finish",function(){onResize()}).on("timeline/loaded",function(){settings.isLoaded=!0,resize(),run()}).on("sequencer/addSequenceItem",function(event,data){Debug.log(data);var waiter=setInterval(function(){settings.isLoaded&&(clearInterval(waiter),addNote(data.note,data.sample,data.division))},50)}).on("sequencer/playStep",function(event,data){playNote(data.note)}).on("sequencer/clearSequence",function(event,data){clearTimeline()})},onResize=function(){resize()},onLoop=function(){run()},build=function(){settings.svg.timeline=Snap(512,512).attr("id",settings.selector.timeline.replace("#","")),settings.svg.placeholder=Snap(512,512).attr("id",settings.selector.placeholder.replace("#",""));for(var key in settings.layer)settings.layer.hasOwnProperty(key)&&addLayer(settings.layer[key],"timeline");for(var key in settings.layerNotes)settings.layerNotes.hasOwnProperty(key)&&addLayer(settings.layerNotes[key],"placeholder")},addLayer=function(filename,target){settings.zIndex=settings.zIndex+settings.zIndexStep;var index=settings.zIndex;Snap.load("dist/img/"+filename+".svg",function(svg){var group=svg.select("g"),indexMax=0,groups=settings.svg[target].selectAll("g");$.each(groups,function(){var g=$(this),i=parseInt(g[0].attr("data-index"));indexMax=i>indexMax?i:indexMax}),group.attr({"data-index":index}),index>=indexMax?group.appendTo(settings.svg[target]):group.prependTo(settings.svg[target]),$(settings.selector[target]).appendTo($(settings.selector.wrapper)),settings.svgLoaded=settings.svgLoaded+1,settings.svgLoaded===Object.keys(settings.layer).length+Object.keys(settings.layerNotes).length&&$(document).trigger("timeline/loaded")})},resize=function(){Debug.log("Timeline.resize()"),settings.size=$(settings.selector.wrapper).width(),settings.scaleFactor=settings.size/512,$(settings.selector.timeline+", "+settings.selector.placeholder).css({transform:"scale( "+settings.scaleFactor+", "+settings.scaleFactor+" )"}),settings.svg.timeline.selectAll("path").attr({strokeWidth:1/settings.scaleFactor}),settings.svg.placeholder.selectAll("path").attr({strokeWidth:1/settings.scaleFactor})},run=function(){var runner=$("#"+settings.layer.runner),progress=Sequencer.getProgress(),angle=360*progress;TweenLite.to(runner,0,{transformOrigin:"50% 50%",rotation:angle,ease:Linear.easeNone})},addNote=function(note,sample,division){Debug.log("Timeline.addNote()",note,sample,division);var layer=settings.svg.placeholder.select("."+settings.layerNotes[sample]);if(layer){layer=layer.clone();var _note={note:note,sample:sample,layer:layer};settings.notes.push(_note);var angle=note/division*360;switch(layer.prependTo(settings.svg.timeline),TweenLite.to(layer.node,0,{transformOrigin:"50% 50%",rotation:angle,ease:Linear.easeNone}),sample){case 0:animateLine(layer.select(".shape"),.5,1);break;case 1:animateLine(layer.select(".shape"),.5,-1);break;case 2:animateLine(layer.select(".shape"),.25,-1);break;case 3:animateLine(layer.select(".shape"),.5,-1);break;case 4:}}},clearTimeline=function(){Debug.log("Timeline.clearTimeline()"),settings.notes=[],settings.svg.timeline.selectAll(".timeline--note").remove()},animateLine=function(path,duration,direction){if(path){var length=path.getTotalLength();$(path.node).css({strokeDasharray:length,strokeDashoffset:length*direction}),TweenLite.to(path.node,duration,{strokeDashoffset:0,ease:Power4.easeInOut})}},playNote=function(note){Debug.log("Sequencer.playNote()",note);for(var i=0;i<settings.notes.length;i++)settings.notes[i].note===note&&(new TimelineLite).fromTo(settings.notes[i].layer.select(".shape").node,.5,{transformOrigin:"50% 50%",scaleX:1.5,scaleY:1.5,strokeOpacity:.75,ease:Elastic.easeOut.config(1,.3)},{transformOrigin:"50% 50%",scaleX:1,scaleY:1,strokeOpacity:1,ease:Elastic.easeOut.config(1,.3)})};return{init:function(){init()}}}();$(document).ready(function(){Timeline.init()});var Ui=function(){var settings={selector:{title:"h1",button:".control-button",controls:{toggle:".ui-toggle--controls"},shareInput:".share-url-input"},isVisible:{controls:!1}},init=function(){Modernizr.touchevents&&toggleControls(),bindEventHandlers()},bindEventHandlers=function(){$(document).on("click",settings.selector.controls.toggle,function(event){event.preventDefault(),toggleControls()}).on("mousedown touchstart",settings.selector.button,function(event){event.preventDefault(),Debug.log("mousedown / touchstart");var button=$(this);if(button.attr("data-sample")){var sample=parseInt($(this).attr("data-sample"));$(document).trigger("ui/clickButton",[{sample:sample}])}if(button.attr("data-action")){var action=$(this).attr("data-action");$(document).trigger("ui/clickButton",[{action:action}])}}).on("sequencer/playSample",function(event,data){var sample=data.sample;highlightButton(sample),highlightTitle()}).on("sequencer/saveSequence",function(event,data){setUrl(data.data)})},highlightButton=function(sample){Debug.log("Ui.highlightButton()",sample);var button=$(settings.selector.button).filter('[data-sample="'+sample+'"]');$("html").css("backgroundColor");(new TimelineLite).to(button,.05,{backgroundColor:"#fff"}).to(button,.05,{backgroundColor:"rgba( 255,255,255,0.01 )"})},highlightTitle=function(){if(Debug.log("Ui.highlightTitle()"),!Modernizr.touchevents&&Viewport.getWidth()>768){var title=$(settings.selector.title);(new TimelineLite).to(title,.01,{opacity:1}).to(title,.05,{opacity:.5})}},toggleControls=function(){settings.isVisible.controls?$("html").removeClass("visible--ui-controls"):$("html").addClass("visible--ui-controls"),settings.isVisible.controls=!settings.isVisible.controls},setUrl=function(hash){Debug.log("Ui.setUrl()",hash);var url=location.protocol+"//"+location.hostname+location.pathname;url=url+"#"+hash,$(settings.selector.shareInput).val(url)};return{init:function(){init()}}}();$(document).ready(function(){Ui.init()});var Url=function(){var settings={hash:"",isChanging:!1},init=function(){Debug.log("url.init()"),onHashchange(),bindEventHandlers(),$(document).trigger("url/init",[{hash:settings.hash}])},bindEventHandlers=function(){$(window).on("hashchange",function(){settings.isChanging||(Debug.log("hashchange"),onHashchange())}),$(document).on("sequencer/clearSequence",function(event,data){set("")})},onHashchange=function(){var hash=location.hash;"#"===hash.substr(0,1)&&(settings.hash=hash.substr(1,hash.length)),settings.hash&&$(document).trigger("url/change",[{hash:settings.hash}])},set=function(hash){settings.isChanging=!0,location.hash=hash,setTimeout(function(){settings.isChanging=!1},500)};return{init:function(){init()}}}();$(document).ready(function(){Url.init()});