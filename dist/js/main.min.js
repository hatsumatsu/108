var Debug=function(){var settings={isLocal:!1,isActive:!0,keyboardKeys:{toggle:68}},init=function(){settings.isLocal=location.href.indexOf("local")>-1,settings.isActive=settings.isLocal,bindEventHandlers()},bindEventHandlers=function(){window.addEventListener("keyup",function(event){event.keyCode!==settings.keyboardKeys.toggle&&event.which!==settings.keyboardKeys.toggle||(settings.isActive=!settings.isActive)})},log=function(){(settings.isLocal||settings.isActive)&&console.log.apply(console,arguments)};return{init:function(){init()},log:log}}();Debug.init();var Viewport=function(){var settings={width:0,height:0,documentHeight:0,nowLoop:Date.now(),visibility:!0,fps:1e3/60},init=function(){settings.element=$(window),onResizeFinish(),pageVisibility(),onLoop()},onLoop=function(){requestAnimationFrame(onLoop);var now=Date.now(),elapsed=now-settings.nowLoop;elapsed>settings.fps&&(settings.nowLoop=now-elapsed%settings.fps,$(document).trigger("viewport/loop",[{now:now}]),"requestAnimationFrame"==settings.scrollDetectionMode&&(settings._scrollTop=settings.scrollTop,settings.scrollTop=settings.element.scrollTop(),settings.scrollTop!=settings._scrollTop&&$(document).trigger("viewport/scroll")))},onResizeFinish=function(){settings.width=settings.element.width(),settings.height=settings.element.height(),settings.documentHeight=$("html").outerHeight()},pageVisibility=function(){function handleVisibilityChange(){document[hidden]?($(document).trigger("viewport/visibility",[{visibility:!1}]),settings.visibility=!1):($(document).trigger("viewport/visibility",[{visibility:!0}]),settings.visibility=!0)}var hidden,visibilityChange;"undefined"!=typeof document.hidden?(hidden="hidden",visibilityChange="visibilitychange"):"undefined"!=typeof document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange"),document.addEventListener(visibilityChange,handleVisibilityChange,!1)},getWidth=function(){return settings.width},getHeight=function(){return settings.height};return{init:function(){init()},getWidth:function(){return getWidth()},getHeight:function(){return getHeight()}}}();$(document).ready(function(){Viewport.init()});var Ui=function(){var settings={selector:{title:"h1",button:".control-button",controls:{toggle:".ui-toggle--controls"},share:{setname:".share-name-input",getname:".username",toggle:".ui-toggle--share",url:".share-url-input",button:".share-url-button",close:".ui-modal-close--share",link:".share-link"},info:{toggle:".ui-toggle--info",close:".ui-modal-close--info"},modal:{wrapper:"[data-modal]",toggle:'[data-modal-action="toggle"]'}},isVisible:{controls:!1,share:!1,info:!1},shareServices:{facebook:{label:"Facebook",url:"https://facebook.com/sharer/sharer.php?u={url}"},twitter:{label:"Twitter",url:"http://www.twitter.com/share?url={url}"}},url:{protocol:location.protocol+"//",hostname:location.hostname,pathname:location.pathname,name:"",sequencerID:"",all:""}},init=function(){toggleControls(),!Cookies.get("yasuke--visited")&&location.href.indexOf("demo")<0&&toggleModal("info"),Cookies.set("yasuke--visited",!0,{expires:30,path:""}),bindEventHandlers(),setName()},bindEventHandlers=function(){$(document).on("url/init",function(event,data){data.name&&($(settings.selector.share.getname).addClass("active").text(data.name),getName(data.name))}).on("click",settings.selector.controls.toggle,function(event){event.preventDefault(),toggleControls()}).on("click",settings.selector.modal.toggle,function(event){event.preventDefault();var id=$(this).closest(settings.selector.modal.wrapper).attr("data-modal");toggleModal(id),$(this).is(settings.selector.share.toggle)&&$(document).trigger("ui/openShare",[{hash:Ui.getHash()}])}).on("click",settings.selector.button,function(event){event.preventDefault()}).on("mousedown touchstart",settings.selector.button,function(event){event.preventDefault();var button=$(this);if(button.attr("data-sample")){var sample=parseInt($(this).attr("data-sample"));$(document).trigger("ui/clickButton",[{sample:sample}])}if(button.attr("data-action")){var action=$(this).attr("data-action");$(document).trigger("ui/clickButton",[{action:action}])}}).on("click",settings.selector.share.link,function(event){event.preventDefault();var service=$(this).attr("data-service");service&&(setUrl(),openShareWindow(service,settings.url.all))}).on("sequencer/playSample",function(event,data){var sample=data.sample;highlightButton(sample),highlightTitle()}).on("sequencer/saveSequence",function(event,data){setSequencerID(data.data)}).on("sequencer/toggleMetronome",function(event,data){setButton("shift",data.state)}).on("focus",settings.selector.share.url,function(event){$(this).select()}),new Clipboard(settings.selector.share.button)},highlightButton=function(sample){var button=$(settings.selector.button).filter('[data-sample="'+sample+'"]');$("html").css("backgroundColor");(new TimelineLite).to(button,.05,{backgroundColor:"#fff"}).to(button,.05,{backgroundColor:"rgba( 255,255,255,0.01 )"})},highlightTitle=function(){if(!Modernizr.touchevents){var title=$(settings.selector.title);(new TimelineLite).to(title,.02,{color:"gray"}).to(title,.05,{color:"white"})}},toggleControls=function(){if(settings.isVisible.controls)$("html").removeClass("visible--ui-controls"),$(".timeline").attr("style",""),$(".ui-toggle--share").attr("style","");else{$("html").addClass("visible--ui-controls");var height=$(".ui--controls").outerHeight();$(".timeline").attr("style","bottom:"+(height+40)+"px"),$(".ui-toggle--share").attr("style","bottom:"+height+"px")}settings.isVisible.controls=!settings.isVisible.controls},setButton=function(key,state){var button=$(settings.selector.button).filter('[data-key="'+key+'"]');button.length>0&&(state?button.addClass("active"):button.removeClass("active"))},toggleModal=function(id){settings.isVisible[id]?$("html").removeClass("visible--ui-"+id):$("html").addClass("visible--ui-"+id),settings.isVisible[id]=!settings.isVisible[id]},getName=function(name){setName(name)},setName=function(initName){initName&&$(settings.selector.getname).text(initName),$(settings.selector.share.setname)[0].oninput=function(){var name=$(this).val();if("@"===name.slice(-1)){$(this).val(name.slice(0,-1));var name=$(this).val()}name.length>0?($(settings.selector.share.getname).addClass("active").text(name),$(document).trigger("Ui/changeName",[{name:name}]),settings.url.name=name.replace(/ /g,"-")):($(settings.selector.share.getname).removeClass("active").text(""),settings.url.name=""),setUrl()}},setSequencerID=function(id){id.length>0?settings.url.sequencerID=id:settings.url.sequencerID="",setUrl()},setUrl=function(hash){var random="b"+(Math.round(5*Math.random())+1)+"/";settings.url.pathname=location.pathname+random;var url=settings.url.protocol+settings.url.hostname+settings.url.pathname,parameters="";(settings.url.name||settings.url.sequencerID)&&(parameters="?",settings.url.name&&(parameters+="n"+settings.url.name+"@"),settings.url.sequencerID&&(parameters+="s"+settings.url.sequencerID)),settings.url.all=url+parameters,window.history.pushState("","","?"),$(settings.selector.share.url).val(settings.url.all)},getHash=function(){return settings.url.hash},openShareWindow=function(service,url){if(settings.shareServices[service]){var url=settings.shareServices[service].url.replace("{url}",url);window.open(url,"108Share","width=520,height=320,menubar=no,location=yes,resizable=no,scrollbars=yes,status=no")}};return{init:function(){init()},getHash:function(){return getHash()}}}();$(document).ready(function(){Ui.init()});var Sequencer=function(){var settings={keyboardKeys:{65:0,83:1,68:2,70:3,71:4,72:5},samples:{0:{src:"dist/samples/conga.mp3",velocity:4},1:{src:"dist/samples/palmas.mp3",velocity:4},2:{src:"dist/samples/hihat.mp3",velocity:4},3:{src:"dist/samples/kick1.mp3",velocity:4},4:{src:"dist/samples/kick2.mp3",velocity:4},5:{src:"dist/samples/cora.mp3",velocity:4}},bpm:108,division:16,isPlaying:!1,backPlaying:!1,isRecording:!0,isLoaded:!1,isMetronoming:!1,introStop:!1,sequence:[],lastStep:0,timeLastStep:0,timeBetweenSteps:0,analyserValue:0,sampleId:0},init=function(){initSampler(),initSignal(),initPlayback(),initMetronome(),bindEventHandlers()},bindEventHandlers=function(){$(document).on("sequencer/loaded",function(){settings.isLoaded=!0}).on("keydown",function(event){var checkOverlay=$("html").is(".visible--ui-share, .visible--intro, .visible--ui-info");if(checkOverlay===!1){var key=event.which;16===event.which&&(event.preventDefault(),toggleMetronome()),void 0!==settings.keyboardKeys[key]&&(event.preventDefault(),playSample(settings.keyboardKeys[key]),settings.isRecording&&addSequenceItem(settings.keyboardKeys[key])),32===key&&(event.preventDefault(),togglePlayback()),88===key&&(event.preventDefault(),clearSequence())}}).on("ui/clickButton",function(event,data){if(void 0!==data.sample){var sample=data.sample;playSample(sample),settings.isRecording&&addSequenceItem(sample)}if(data.action){var action=data.action;"play"===action&&togglePlayback(),"clear"===action&&clearSequence(),"metronome"===action&&toggleMetronome()}}).on("timeline/clickAdd",function(event,data){addSequenceItem(data.sample,data.step,!0)}).on("url/init",function(event,data){var sequencerID=data.sequencerID;sequencerID?loadSequence(sequencerID):setTimeout(function(){buildDemoSequence()},0)}).on("sequencer/changeSequence",function(){saveSequence()}).on("history/undo",function(event,data){data.id&&removeSequenceItem(data.step,data.sample,data.division,data.id)}).on("intro/stop",function(){settings.introStop=!0,Tone.Transport.start(),/iPhone|iPad/i.test(navigator.userAgent)===!1&&startPlayback()}).on("viewport/visibility",function(event,data){data.visibility&&settings.backPlaying?startPlayback():(settings.isPlaying===!0?settings.backPlaying=!0:settings.backPlaying=!1,stopPlayback())}),Tone.Buffer.on("load",function(){$(document).trigger("sequencer/loaded")}),setInterval(function(){"running"!==Tone.context.state&&Tone.context.resume()},1e3)},initSignal=function(){settings.sampler.toMaster()},initSampler=function(){for(var samples={},i=0;i<Object.keys(settings.samples).length;i++)samples[i]=settings.samples[i].src;settings.sampler=new Tone.MultiPlayer({urls:samples})},playSample=function(i,time){if(settings.isLoaded){var velocity=settings.samples[i].velocity;settings.sampler.start(i,time,0,velocity),$(document).trigger("sequencer/playSample",[{sample:i}])}settings.isPlaying||startPlayback()},initPlayback=function(){clearSequence(),Tone.Transport.bpm.value=settings.bpm,settings.events=[];for(var i=0;i<settings.division;i++)settings.events.push(i);settings.loop=new Tone.Sequence(function(time,step){settings.timeBetweenSteps=time-settings.timeLastStep,settings.lastStep=step,settings.timeLastStep=time,settings.isMetronoming&&(0===step&&playMetronome(!0),step===settings.division/4*1&&playMetronome(),step===settings.division/4*2&&playMetronome(),step===settings.division/4*3&&playMetronome());for(var i=0;i<Object.keys(settings.samples).length;i++)1===settings.sequence[i][step]&&(playSample(i),$(document).trigger("sequencer/playStep",[{sample:i,step:step}])),2===settings.sequence[i][step]&&(settings.sequence[i][step]=1);$(document).trigger("sequencer/step",[{step:step}])},settings.events,settings.division+"n")},startPlayback=function(){settings.isPlaying=!0,$(document).trigger("sequencer/startPlayback"),settings.loop.start(),StartAudioContext(Tone.context)},stopPlayback=function(){settings.isPlaying=!1,$(document).trigger("sequencer/stopPlayback"),settings.loop.stop()},togglePlayback=function(){settings.isPlaying?stopPlayback():startPlayback()},addSequenceItem=function(i,step,byTimeline){if(!step&&0!==step){var step=Math.round(settings.division*settings.loop.progress);step>=settings.division&&(step=0)}var pending=1;byTimeline||(pending=settings.division*settings.loop.progress<step?2:1),settings.sequence[i][step]||(settings.sequence[i][step]=pending,settings.sampleId+=1,$(document).trigger("sequencer/changeSequence",[{sequence:settings.sequence}]),$(document).trigger("sequencer/addSequenceItem",[{step:step,sample:i,division:settings.division,id:settings.sampleId}])),!settings.isPlaying&&settings.introStop&&startPlayback()},removeSequenceItem=function(step,sample,division,id){settings.sequence[sample][step]&&(settings.sequence[sample][step]=0,$(document).trigger("sequencer/changeSequence",[{sequence:settings.sequence}]),$(document).trigger("sequencer/removeSequenceItem",[{step:step,sample:sample,division:settings.division}]))},saveSequence=function(){for(var data="",data=[],i=0;i<settings.division;i++)data.push([]);for(var i=0;i<settings.sequence.length;i++)for(var j=0;j<settings.sequence[i].length;j++)settings.sequence[i][j]&&data[j].push(i);for(var string="",i=0;i<data.length;i++)data[i].length>0&&(string+=String.fromCharCode(i+65),string+=data[i].join(""));$(document).trigger("sequencer/saveSequence",[{data:string}])},loadSequence=function(string){var matches=string.match(/[A-Za-z][0-9]+/g);if(matches)for(var i=0;i<matches.length;i++){var match=matches[i],step=match[0].charCodeAt(0)-65,samples=match.substr(1,match.length);if(samples.length>0){samples=samples.split("");for(var j=0;j<samples.length;j++)addSequenceItem(samples[j],step)}}},clearSequence=function(){for(var i=0;i<Object.keys(settings.samples).length;i++){for(var track=[],j=0;j<settings.division;j++)track[j]=0;settings.sequence[i]=track}$(document).trigger("sequencer/clearSequence"),$(document).trigger("sequencer/changeSequence")},buildDemoSequence=function(){addSequenceItem(0,0)},initMetronome=function(){settings.metronome=(new Tone.Synth).toMaster()},toggleMetronome=function(){settings.isMetronoming=!settings.isMetronoming,$(document).trigger("sequencer/toggleMetronome",[{state:settings.isMetronoming}])},playMetronome=function(high){var note=high?"C5":"C4";settings.metronome.triggerAttackRelease(note,"16n")},isReady=function(){return!!settings.isLoaded},getProgress=function(){return!!settings.loop&&settings.loop.progress},getSequence=function(){return settings.sequence},getSamples=function(){return settings.samples},getDivision=function(){return settings.division};return{init:function(){init()},isReady:function(){return isReady()},getProgress:function(){return getProgress()},getSequence:function(){return getSequence()},getSamples:function(){return getSamples()},getDivision:function(){return getDivision()}}}();$(document).ready(function(){Sequencer.init()});var History=function(){var settings={maxLength:32},state={keyDown:!1},history={},init=function(){bindEventHandlers(),$(document).trigger("history/init")},bindEventHandlers=function(){$(document).on("sequencer/addSequenceItem",function(event,data){addItem(data.step,data.sample,data.division,data.id)}).on("ui/clickButton",function(event,data){"undo"===data.action&&undo()}).on("keydown",function(event){if(!state.keyDown){state.keyDown=!0;var key=event.which,checkOverlay=$("html").is(".visible--ui-share, .visible--intro, .visible--ui-info");8===key&&checkOverlay===!1&&(event.preventDefault(),undo())}}).on("timeline/clickRemove",function(event,data){undo(data.id)}).on("keyup",function(event){state.keyDown=!1})},addItem=function(step,sample,division,id){id&&(history.length>0&&Object.keys(history).length>settings.maxLength-1&&history.shift(),history[id]={step:step,sample:sample,division:division})},undo=function(specificId){if(specificId){var item=history[specificId];$(document).trigger("history/undo",[{step:item.step,sample:item.sample,division:item.division,id:specificId}]),delete history[specificId]}else if(Object.keys(history).length>0){var id=Object.keys(history)[Object.keys(history).length-1],item=history[id];$(document).trigger("history/undo",[{step:item.step,sample:item.sample,division:item.division,id:id}]),delete history[id]}};return{init:function(){init()}}}();$(document).ready(function(){History.init()});var Timeline=function(){var settings={selector:{wrapper:".timeline-wrapper"},notes:[],svg:{},svgLoaded:0,isLoaded:!1,zIndex:0,zIndexStep:100},init=function(){bindEventHandlers(),build(),$(document).trigger("timeline/init"),$("html").addClass("initiated--timeline"),height()},bindEventHandlers=function(){$(document).on("viewport/loop",function(){onLoop()}).on("timeline/loaded",function(){settings.isLoaded=!0,run()}).on("sequencer/addSequenceItem",function(event,data){var waiter=setInterval(function(){settings.isLoaded&&(clearInterval(waiter),addNote(data.step,data.sample,data.division,data.id))},50)}).on("mousedown touchstart",settings.selector.wrapper+" .step",function(event){event.preventDefault();var sample=$(this);if(sample.attr("data-id")>=0){var id=parseInt($(this).attr("data-id"));removeNote(id),$(document).trigger("timeline/clickRemove",[{id:id}])}else{var sample=parseInt($(this).attr("data-sample")),step=parseInt($(this).attr("data-step"));$(document).trigger("timeline/clickAdd",[{sample:sample,step:step}])}}).on("sequencer/playStep",function(event,data){playNote(data.sample,data.step)}).on("sequencer/clearSequence",function(event,data){clearTimeline()}).on("history/undo",function(event,data){data.id&&removeNote(data.id)})},onLoop=function(){run()},build=function(){var sequencer=Sequencer.getDivision(),samples=Object.keys(Sequencer.getSamples()).length;$(settings.selector.wrapper).append('<div class="runner"></div>');for(var key=0;key<samples;key++){var sample='<div class="sample" data-sample="'+key+'">';$(settings.selector.wrapper).append(sample);for(var i=0;i<sequencer;i++){var step='<div class="step" data-sample="'+key+'" data-step="'+i+'"><div class="content">';$(".sample[data-sample="+key+"]").append(step)}}$(document).trigger("timeline/loaded")},run=function(){var runner=$(settings.selector.wrapper+" .runner"),progress=100*Sequencer.getProgress();TweenLite.to(runner,0,{x:10*progress+"%",ease:Linear.easeNone})},addNote=function(step,sample,division,id){var layer=$('.timeline-wrapper .sample[data-sample="'+sample+'"] .step[data-step="'+step+'"]'),layerContent=$(layer).find(".content"),note={step:step,sample:sample,layer:layer,id:id};settings.notes.push(note),layer.attr("data-id",id),$(layerContent).addClass("added"),setTimeout(function(){$(layerContent).removeClass("added")},138)},removeNote=function(id){var layer=$('.timeline-wrapper .step[data-id="'+id+'"]');layer&&layer.removeAttr("data-id").find(".content").empty();for(var i=0;i<settings.notes.length;i++)settings.notes[i].id==id&&settings.notes.splice(i,1)},clearTimeline=function(){settings.notes=[],$(".timeline-wrapper .step").removeAttr("data-id"),$(".timeline-wrapper .step .content").empty()},playNote=function(sample,step){for(var i=0;i<settings.notes.length;i++)if(settings.notes[i].step===step){var selector=settings.selector.wrapper+' .step[data-sample="'+sample+'"][data-step="'+step+'"] .content';$(selector).addClass("active"),setTimeout(function(){$(selector).removeClass("active")},138)}},height=function(){var setHeight=function(){if($("html").hasClass("visible--ui-controls")){var height=$(".ui--controls").outerHeight();$(".timeline").attr("style","bottom:"+(height+40)+"px"),$(".ui-toggle--share").attr("style","bottom:"+height+"px")}};setTimeout(function(){setHeight()},50),$(window).resize(function(){setHeight()})},isReady=function(){return!!settings.isLoaded};return{init:function(){init()},isReady:function(){return isReady()}}}();$(document).ready(function(){Timeline.init()});var Url=function(){var settings={sequencerID:"",name:""},init=function(){getParameters(),$(document).trigger("url/init",[{sequencerID:settings.sequencerID,name:settings.name}])},getParameters=function(){var delimiter="@",delimiterEncoded=encodeURIComponent(delimiter);if(location.search){var parameters=location.search.substr(1),listParameters=[];for(parameters.indexOf(delimiter)>0?listParameters=parameters.split(delimiter):parameters.indexOf(delimiterEncoded)>0?listParameters=parameters.split(delimiterEncoded):listParameters.push(parameters),i=0;i<listParameters.length;i++)if("n"==listParameters[i].substr(0,1)){var decode=decodeURI(listParameters[i]),decode=decode.replace(/\-/g," ");settings.name=decode.substr(1,13)}else"s"===listParameters[i].substr(0,1)&&(settings.sequencerID=listParameters[i].substr(1))}};return{init:function(){init()}}}();$(document).ready(function(){Url.init()});var Intro=function(){var settings={selector:{intro:".intro",title:".intro-title",loading:".intro-loading-bar"},element:{},isVisible:!0,duration:4e3,startTime:null,time:null,steps:99,current:0},init=function(){settings.element.title=$(settings.selector.title),settings.step=settings.duration/settings.steps,bindEventHandlers(),$(document).trigger("intro/init"),start()},bindEventHandlers=function(){$(document).on("viewport/loop",function(){onLoop()})},onLoop=function(){},start=function(){settings.startTime=Date.now(),settings.timer=setInterval(function(){settings.isVisible&&(settings.current<settings.steps?countUp():stop())},settings.step),$("html").addClass("visible--intro"),$(document).trigger("intro/start")},stop=function(){settings.isVisible=!1,clearInterval(settings.timer),waitForReady(function(){$(document).trigger("intro/stop"),setTimeout(function(){$(document).one("transitionend",settings.selector.intro,function(){$(settings.selector.intro).remove()}),$("html").removeClass("visible--intro")},1e3)})},countUp=function(){settings.current=settings.current+1,settings.element.title.text(settings.current),$(settings.selector.loading).attr("style","width:"+settings.current+"%")},waitForReady=function(callback){Sequencer&&Timeline&&(settings.waiter=setInterval(function(){Sequencer.isReady()&&Timeline.isReady()&&(clearInterval(settings.waiter),callback())},100))};return{init:function(){init()}}}();$(document).ready(function(){Intro.init()});var Title=function(){var settings={selector:{title:"title"},element:{},text:{title:"",runner:"●",spacer:"   "}},init=function(){settings.element.title=$(settings.selector.title),settings.text.title=settings.element.title.text(),bindEventHandlers()},bindEventHandlers=function(){$(document).on("sequencer/step",function(event,data){onStep(data.step)})},onStep=function(step){for(var text="",i=0;i<Sequencer.getDivision();i++)text+=i===step?settings.text.runner:"·";text+=settings.text.spacer+settings.text.title,set(text)},set=function(text){settings.element.title.text(text)};return{init:function(){init()}}}();$(document).ready(function(){Title.init()});